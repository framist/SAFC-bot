<html lang="en">
<!-- SAFC web demo
     this page's source code fork from https://gitee.com/wdwdwd123/RateMySupervisor
     想爬数据外也可以直接问我要
-->

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>SAFC - 查看导师评价</title>

    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="text-center">
        <h1>🏛️</h1>
        <h1>SAFC - Web</h1>
        <p>
            <b>大学生反诈中心 web 端</b><br />
            <i>元平台、分布式——不只是评价导师</i><br />
            <!-- <a href="https://t.me/SAFC_bot"><del>Telegram 机器人</del></a> | -->
            Web（本站） |
            <a href="https://t.me/SAFC_bak_bot">Telegram 机器人</a> |
            <a href="https://t.me/SAFC_group">群组社区</a> |
            <a href="https://github.com/framist/SAFC-bot"> GitHub</a> <br />
        </p>
    </div>

    
    <div class="container mt-3">
        <div class="comments-info mb-3">
            <div class="row">
                <div class="col align-self-start" id="db-status">
                    连接数据库中 ……
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col col-6">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <label class="input-group-text" for="schoolcateSelector">校别</label>
                    </div>
                    <select class="custom-select" id="schoolcateSelector">
                        <option selected>学校类别</option>
                    </select>
                </div>
            </div>
            <div class="col col-6">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <label class="input-group-text" for="universitySelector">学校</label>
                    </div>
                    <select class="custom-select" id="universitySelector">
                        <option selected>所在学校</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col col-6">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <label class="input-group-text" for="departmentSelector">院系</label>
                    </div>
                    <select class="custom-select" id="departmentSelector">
                        <option selected>所在院系</option>
                    </select>
                </div>
            </div>
            <div class="col col-6">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <label class="input-group-text" for="supervisorSelector">导师</label>
                    </div>
                    <select class="custom-select" id="supervisorSelector">
                        <option selected>姓名</option>
                    </select>
                </div>
            </div>

        </div>

        <div class="comments-info mb-3">
            <div class="row">
                <div class="col align-self-start" id="comments-num">
                    检索到 0 条评论
                </div>
            </div>
        </div>
        <div class="descriptions">
        </div>
    </div>

    <div class="text-center">
        <!-- <i>this page's source code fork from <a href="https://gitee.com/wdwdwd123/RateMySupervisor">RateMySupervisor</a>
        </i> <br> -->
        <i>web 端现只提供基本的查看功能，数据约滞后一日<br /> 
            增加导师、增加评价、查看与增加嵌套评价等更多功能请使用 <a href="https://t.me/SAFC_bak_bot"> bot </a>！</i>  <br /> 
        <!-- <a href="https://github.com/framist/SAFC-bot">SAFC</a> - 社群，保护，开放 -->
    </div>

    <script>
        function setSelectOptions(selector, options) {
            selector.empty();
            options.forEach(function (value, i) {
                var option = new Option(value, i);
                selector.append($(option));
            });
        }

        function show_comments() {
            contentDiv.empty();
            currentCm.forEach(function (value, i) {
                var desc = value['description'].replace(/\n/g, "<br>");
                var card = $(`<div class="card mb-3">
                <div class="card-header">
                    <div class="row">
                        <div class="col">
                            <b> ${i + 1} | ${currentSp} - <code>${value['object']}</code> </b>
                        </div>
                        <div class="col" style="text-align: right;">
                            <b>${value['comment_type']} | ${value['date']}</b>
                        </div>
                    </div>
                </div>
                    <div class="card-body">
                        <p class="card-title">来自 ${value['source_cate']} 的评价 - <code>${value['id']}</code></p>
                        <p class="card-text">${desc}</p>
                        <div class="nest-descriptions">
                            <!-- todo -->
                        </div>
                    </div>
                </div >`);
                if (currentUn == '西安电子科技大学') {
                    // 你懂的
                    card = $(`<div class="card mb-3">
                        <div class="card-header">
                            <div class="row">
                                <div class="col">
                                    <b> 不予显示 </b>
                                </div>
                            </div>
                        </div>`);
                }
                contentDiv.append($(card));
            })
        }

        //Selectors
        var schoolcate_sel = $('#schoolcateSelector');
        var university_sel = $('#universitySelector');
        var department_sel = $('#departmentSelector');
        var supervisor_sel = $('#supervisorSelector');
        //Buttons and Divs
        var contentDiv = $('.descriptions');
        var commentsNumDiv = $('#comments-num');
        var statusDiv = $('#db-status');
        //Initialize selection conditions
        var schoolcates = new Array();
        var universities = new Array();
        var departments = new Array();
        var supervisors = new Array();
        var currentCt = '';
        var currentUn = '';
        var currentDp = '';
        var currentSp = '';
        var currentCm = new Array();

        const API_URL = "https://safc.framist.top/api/query";

        $.get("https://safc.framist.top/api", (d) => {
            statusDiv.empty();
            statusDiv.append(`${d}`);
        }).fail(() => {
            statusDiv.empty();
            statusDiv.append(`😢 可能后端服务器出故障了 🐎 速速拷打<a href="https://t.me/SAFC_admin">管理员</a>`);
        });

        $.get(API_URL, (d) => {
            schoolcates = d;
            setSelectOptions(schoolcate_sel, schoolcates);
            schoolcate_sel.trigger('change');
        });            

        //Selector change 

        schoolcate_sel.change(() => {
            currentCt = schoolcates[schoolcate_sel.val()];
            $.get(API_URL, { school_cate: currentCt }, (d) => {
                universities = d;
                setSelectOptions(university_sel, universities);
                university_sel.trigger('change');
            });
        });

        university_sel.change(() => {
            currentUn = universities[university_sel.val()];
            $.get(API_URL,
                { school_cate: currentCt, university: currentUn },
                (d) => {
                    departments = d;
                    setSelectOptions(department_sel, departments);
                    department_sel.trigger('change');
                }
            );
        });

        department_sel.change(() => {
            currentDp = departments[department_sel.val()];
            $.get(API_URL,
                { school_cate: currentCt, university: currentUn, department: currentDp },
                (d) => {
                    supervisors = d;
                    setSelectOptions(supervisor_sel, supervisors);
                    supervisor_sel.trigger('change');
                }
            );
        })
        supervisor_sel.change(() => {
            currentSp = supervisors[supervisor_sel.val()];
            $.get(API_URL,
                {
                    school_cate: currentCt,
                    university: currentUn,
                    department: currentDp,
                    supervisor: currentSp,
                },
                (d) => {
                    currentCm = d;
                    counts = currentCm.length;
                    commentsNumDiv.empty();
                    commentsNumDiv.append(`检索到 ${counts} 条评论`);
                    show_comments();
                }
            );
        })
    </script>
</body>


</html>